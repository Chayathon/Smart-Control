pipeline {
    agent any
    
    triggers {
        // Trigger ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ push ‡πÉ‡∏ô Git (‡πÉ‡∏ä‡πâ webhook ‡∏à‡∏≤‡∏Å GitHub)
        githubPush()
        // ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ pollSCM('H/5 * * * *') ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡∏∏‡∏Å 5 ‡∏ô‡∏≤‡∏ó‡∏µ
    }
    
    environment {
        // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Raspberry Pi deployment
        DEPLOY_PATH = '/opt/Backend_Node_radio'
        PM2_APP_NAME = 'node-audio'
        GITHUB_REPO = credentials('github-repo-url') // ‡πÄ‡∏Å‡πá‡∏ö URL ‡∏Ç‡∏≠‡∏á repo ‡πÉ‡∏ô Jenkins credentials
        NODE_ENV = 'production'
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo 'üì• Pulling latest code from GitHub...'
                checkout scm
            }
        }
        
        stage('Install Dependencies') {
            steps {
                dir('backend') {
                    echo 'üì¶ Installing Node.js dependencies...'
                    sh 'npm ci --production'
                }
            }
        }
        
        stage('Prepare Environment') {
            steps {
                dir('backend') {
                    script {
                        echo '‚öôÔ∏è Setting up environment variables...'
                        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå .env ‡∏à‡∏≤‡∏Å Jenkins credentials
                        withCredentials([
                            string(credentialsId: 'mongodb-uri', variable: 'MONGODB_URI'),
                            string(credentialsId: 'mongodb-name', variable: 'MONGODB_DBNAME'),
                            string(credentialsId: 'access-token-secret', variable: 'ACCESS_TOKEN_SECRET'),
                            string(credentialsId: 'refresh-token-secret', variable: 'REFRESH_TOKEN_SECRET'),
                            string(credentialsId: 'mqtt-username', variable: 'MQTT_USERNAME'),
                            string(credentialsId: 'mqtt-password', variable: 'MQTT_PASSWORD')
                        ]) {
                            sh '''
                                echo "NODE_ENV=production" > .env
                                echo "PORT=8080" >> .env
                                echo "MONGODB_URI=${MONGODB_URI}" >> .env
                                echo "MONGODB_DBNAME=${MONGODB_DBNAME}" >> .env
                                echo "ACCESS_TOKEN_SECRET=${ACCESS_TOKEN_SECRET}" >> .env
                                echo "REFRESH_TOKEN_SECRET=${REFRESH_TOKEN_SECRET}" >> .env
                                echo "MQTT_URL=ws://localhost:9001" >> .env
                                echo "MQTT_USERNAME=${MQTT_USERNAME}" >> .env
                                echo "MQTT_PASSWORD=${MQTT_PASSWORD}" >> .env
                                echo "MQTT_TOPIC_COMMAND=mass-radio/zone1/command" >> .env
                                echo "MQTT_TOPIC_STATUS=mass-radio/zone1/status" >> .env
                                echo "MQTT_IGNORE_RETAINED=true" >> .env
                                echo "AUTO_REPLAY_ON_END=false" >> .env
                            '''
                        }
                    }
                }
            }
        }
        
        stage('Run Tests') {
            steps {
                dir('backend') {
                    echo 'üß™ Running tests...'
                    sh 'npm test || echo "No tests configured"'
                }
            }
        }
        
        stage('Deploy to Raspberry Pi') {
            steps {
                dir('backend') {
                    script {
                        echo 'üöÄ Deploying to Raspberry Pi at ${DEPLOY_PATH}...'
                        
                        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏î‡πÄ‡∏£‡∏Å‡∏ó‡∏≠‡∏£‡∏µ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ (‡πÉ‡∏ä‡πâ sudo)
                        sh """
                            sudo mkdir -p ${DEPLOY_PATH}
                            sudo mkdir -p ${DEPLOY_PATH}/logs
                            sudo mkdir -p ${DEPLOY_PATH}/data
                            sudo mkdir -p ${DEPLOY_PATH}/storage
                            sudo mkdir -p ${DEPLOY_PATH}/uploads
                            sudo chown -R jenkins:jenkins ${DEPLOY_PATH}
                        """
                        
                        // ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏õ‡∏¢‡∏±‡∏á deployment directory (‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô node_modules)
                        sh """
                            rsync -av --delete \
                                --exclude 'node_modules' \
                                --exclude '.git' \
                                --exclude 'logs/*' \
                                --exclude 'data/*' \
                                --exclude 'storage/*' \
                                --exclude 'uploads/*' \
                                ./ ${DEPLOY_PATH}/
                        """
                        
                        // Install dependencies ‡∏ó‡∏µ‡πà deployment path
                        sh """
                            cd ${DEPLOY_PATH}
                            npm ci --production
                        """
                    }
                }
            }
        }
        
        stage('Restart PM2') {
            steps {
                script {
                    echo 'üîÑ Restarting PM2 process: ${PM2_APP_NAME}...'
                    
                    sh """
                        cd ${DEPLOY_PATH}
                        
                        # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ PM2 ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
                        if ! command -v pm2 &> /dev/null; then
                            echo "PM2 not found, installing..."
                            npm install -g pm2
                        fi
                        
                        # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÅ‡∏≠‡∏õ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏±‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                        if pm2 describe ${PM2_APP_NAME} > /dev/null 2>&1; then
                            echo "Restarting existing PM2 process..."
                            pm2 restart ${PM2_APP_NAME} --update-env
                        else
                            echo "Starting new PM2 process..."
                            pm2 start ecosystem.config.js
                        fi
                        
                        # ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å PM2 configuration
                        pm2 save
                        
                        # ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
                        pm2 list
                        pm2 info ${PM2_APP_NAME}
                    """
                }
            }
        }
        
        stage('Health Check') {
            steps {
                script {
                    echo 'üè• Checking application health...'
                    
                    // ‡∏£‡∏≠‡πÉ‡∏´‡πâ application startup
                    sleep(time: 10, unit: 'SECONDS')
                    
                    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ backend ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥
                    retry(3) {
                        sh """
                            curl -f http://localhost:8080/devices/status || exit 1
                            echo "‚úÖ Health check passed!"
                        """
                    }
                }
            }
        }
        
        stage('Cleanup') {
            steps {
                script {
                    echo 'üßπ Cleaning up old PM2 logs...'
                    sh """
                        cd ${DEPLOY_PATH}
                        pm2 flush ${PM2_APP_NAME}
                        
                        # ‡∏•‡∏ö log files ‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏≤‡∏¢‡∏∏‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 7 ‡∏ß‡∏±‡∏ô
                        find ${DEPLOY_PATH}/logs -name "*.log" -mtime +7 -delete || true
                    """
                }
            }
        }
    }
    
    post {
        success {
            echo '‚úÖ Deployment to Raspberry Pi successful!'
            echo "Application is running at: http://localhost:8080"
            
            sh """
                cd ${DEPLOY_PATH}
                echo "Current PM2 Status:"
                pm2 list
            """
        }
        failure {
            echo '‚ùå Deployment failed!'
            
            sh """
                if [ -d ${DEPLOY_PATH} ]; then
                    cd ${DEPLOY_PATH}
                    echo "PM2 Status:"
                    pm2 list || true
                    echo "\nPM2 Logs (last 50 lines):"
                    pm2 logs ${PM2_APP_NAME} --lines 50 --nostream || true
                else
                    echo "Deploy directory does not exist yet"
                fi
            """
        }
        always {
            // ‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
            sh 'rm -f backend/.env'
        }
    }
}
