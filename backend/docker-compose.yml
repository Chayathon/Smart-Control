version: "3.8"

services:
    backend:
        build:
            context: .
            dockerfile: Dockerfile
        container_name: smart-control-backend
        restart: unless-stopped
        ports:
            - "${PORT:-8080}:8080"
        environment:
            - NODE_ENV=production
            - PORT=${PORT:-8080}
            - MONGODB_URI=mongodb://mongodb:27017
            - MONGODB_DBNAME=${MONGODB_DBNAME:-radio_db}
            - ACCESS_TOKEN_SECRET=${ACCESS_TOKEN_SECRET}
            - REFRESH_TOKEN_SECRET=${REFRESH_TOKEN_SECRET}
            - MQTT_URL=${MQTT_URL:-ws://mqtt:9001}
            - MQTT_USERNAME=${MQTT_USERNAME:-admin}
            - MQTT_PASSWORD=${MQTT_PASSWORD:-admin}
            - MQTT_TOPIC_COMMAND=${MQTT_TOPIC_COMMAND:-mass-radio/zone1/command}
            - MQTT_TOPIC_STATUS=${MQTT_TOPIC_STATUS:-mass-radio/zone1/status}
            - MQTT_IGNORE_RETAINED=${MQTT_IGNORE_RETAINED:-true}
            - AUTO_REPLAY_ON_END=${AUTO_REPLAY_ON_END:-false}
            - ICECAST_HOST=${ICECAST_HOST:-localhost}
            - ICECAST_PORT=${ICECAST_PORT:-8000}
            - ICECAST_USERNAME=${ICECAST_USERNAME:-source}
            - ICECAST_PASSWORD=${ICECAST_PASSWORD:-admin}
            - ICECAST_MOUNT=${ICECAST_MOUNT:-/stream.mp3}
        volumes:
            - ./data:/app/data
            - ./storage:/app/storage
            - ./uploads:/app/uploads
        depends_on:
            - mongodb
            - mqtt
        networks:
            - smart-control-network
        healthcheck:
            test:
                [
                    "CMD",
                    "node",
                    "-e",
                    "require('http').get('http://localhost:8080/devices/status', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})",
                ]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 40s

    mongodb:
        image: mongo:7-jammy
        container_name: smart-control-mongodb
        restart: unless-stopped
        ports:
            - "27017:27017"
        environment:
            - MONGO_INITDB_DATABASE=${MONGODB_DBNAME:-radio_db}
        volumes:
            - mongodb_data:/data/db
            - mongodb_config:/data/configdb
        networks:
            - smart-control-network
        healthcheck:
            test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
            interval: 10s
            timeout: 5s
            retries: 5
            start_period: 20s

    mqtt:
        image: eclipse-mosquitto:2
        container_name: smart-control-mqtt
        restart: unless-stopped
        ports:
            - "1883:1883"
            - "9001:9001"
        volumes:
            - ./mosquitto.conf:/mosquitto/config/mosquitto.conf
            - mqtt_data:/mosquitto/data
            - mqtt_logs:/mosquitto/log
        networks:
            - smart-control-network
        healthcheck:
            test:
                [
                    "CMD",
                    "mosquitto_sub",
                    "-t",
                    "$$SYS/#",
                    "-C",
                    "1",
                    "-i",
                    "healthcheck",
                    "-W",
                    "3",
                ]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 10s

volumes:
    mongodb_data:
        driver: local
    mongodb_config:
        driver: local
    mqtt_data:
        driver: local
    mqtt_logs:
        driver: local

networks:
    smart-control-network:
        driver: bridge
